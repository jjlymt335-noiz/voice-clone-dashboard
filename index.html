<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Clone 数据看板</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            color: #2d3748;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            background: linear-gradient(90deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header .update-time {
            color: #718096;
            font-size: 14px;
        }

        .period-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .period-btn {
            padding: 8px 20px;
            border: 1px solid #cbd5e0;
            background: #fff;
            color: #4a5568;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .period-btn.active {
            background: linear-gradient(90deg, #f093fb, #f5576c);
            border-color: transparent;
            color: #fff;
        }

        .period-btn:hover {
            border-color: #f093fb;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .section {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #f093fb, #f5576c);
            border-radius: 2px;
        }

        /* 漏斗区域 */
        .funnel-container {
            display: flex;
            gap: 30px;
        }

        .funnel-chart {
            flex: 1;
            height: 400px;
        }

        .funnel-details {
            width: 420px;
        }

        .funnel-step {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .funnel-step:hover {
            background: #edf2f7;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 12px;
            color: #fff;
        }

        .step-info {
            flex: 1;
        }

        .step-name {
            font-size: 14px;
            color: #2d3748;
            margin-bottom: 2px;
        }

        .step-event {
            font-size: 11px;
            color: #a0aec0;
        }

        .step-metrics {
            text-align: right;
        }

        .step-metrics-row {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-bottom: 4px;
        }

        .step-metric-col {
            text-align: center;
            min-width: 70px;
        }

        .step-metric-label {
            font-size: 10px;
            color: #718096;
            margin-bottom: 2px;
        }

        .step-metric-value {
            font-size: 16px;
            font-weight: 600;
        }

        .step-metric-value.users {
            color: #f5576c;
        }

        .step-metric-value.count {
            color: #a0aec0;
        }

        .step-rate {
            font-size: 12px;
            color: #48bb78;
        }

        .step-rate-overall {
            font-size: 11px;
            color: #718096;
        }

        .step-detail-breakdown {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed #e2e8f0;
            font-size: 11px;
            color: #718096;
        }

        .step-detail-breakdown div {
            margin-bottom: 2px;
        }

        /* KPI 卡片 */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .kpi-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .kpi-label {
            font-size: 13px;
            color: #718096;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .kpi-sub {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }

        /* 图表区域 */
        .chart-container {
            height: 300px;
        }

        /* 独立模块 */
        .module-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        /* 视图切换按钮 */
        .view-toggle {
            display: flex;
            gap: 4px;
        }

        .toggle-btn {
            padding: 4px 10px;
            font-size: 11px;
            border: 1px solid #cbd5e0;
            background: #fff;
            color: #4a5568;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: linear-gradient(90deg, #f093fb, #f5576c);
            border-color: transparent;
            color: #fff;
        }

        .toggle-btn:hover {
            border-color: #f093fb;
        }

        /* 第二层指标 */
        .metrics-layer {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .metric-group {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
        }

        .metric-group-title {
            font-size: 14px;
            font-weight: 600;
            color: #f5576c;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric-item {
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-name {
            font-size: 13px;
            color: #718096;
            margin-bottom: 4px;
        }

        .metric-value-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .metric-main-value {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
        }

        .metric-sub-value {
            font-size: 12px;
            color: #718096;
        }

        /* 响应式 */
        @media (max-width: 1200px) {
            .funnel-container {
                flex-direction: column;
            }
            .funnel-details {
                width: 100%;
            }
            .module-grid,
            .metrics-layer {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Voice Clone 数据看板</h1>
        <div class="update-time" id="updateTime">数据更新时间：加载中...</div>
    </div>

    <div class="period-selector">
        <button class="period-btn" data-period="昨天">昨天</button>
        <button class="period-btn active" data-period="近3天">近3天</button>
        <button class="period-btn" data-period="近7天">近7天</button>
    </div>
    <div style="text-align: center; color: #718096; font-size: 12px; margin-top: -20px; margin-bottom: 20px;">
        * 昨天 = 上一个完整数据日；近3天/7天 = 往前推相应天数的完整数据（不含今天）
    </div>

    <div class="dashboard">
        <!-- 核心漏斗 -->
        <div class="section">
            <div class="section-title">核心漏斗</div>
            <div class="funnel-container">
                <div class="funnel-chart" id="funnelChart"></div>
                <div class="funnel-details" id="funnelDetails"></div>
            </div>
        </div>

        <!-- 趋势图 -->
        <div class="section">
            <div class="section-title" style="justify-content: space-between;">
                <span>近14天趋势</span>
                <div class="view-toggle">
                    <button class="toggle-btn active" data-view="absolute" onclick="setTrendView('absolute')">绝对数量</button>
                    <button class="toggle-btn" data-view="percentage" onclick="setTrendView('percentage')">比例视图</button>
                </div>
            </div>
            <div class="chart-container" id="trendChart"></div>
            <div id="trendFooter" style="text-align: center; color: #718096; font-size: 11px; margin-top: 10px;"></div>
        </div>

        <!-- 第二层指标 -->
        <div class="section">
            <div class="section-title" style="justify-content: space-between;">
                <span>第二层指标</span>
                <div class="view-toggle">
                    <button class="toggle-btn deep-period-btn" data-period="昨天">昨天</button>
                    <button class="toggle-btn deep-period-btn active" data-period="近3天">近3天</button>
                    <button class="toggle-btn deep-period-btn" data-period="近7天">近7天</button>
                </div>
            </div>
            <div class="metrics-layer" id="deepMetrics"></div>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let currentPeriod = '近3天';
        let deepMetricsPeriod = '近3天';
        let trendView = 'absolute';

        // 加载数据
        async function loadData() {
            try {
                const response = await fetch('data/dashboard_data.json');
                dashboardData = await response.json();
                document.getElementById('updateTime').textContent = `数据更新时间：${dashboardData.update_time}`;
                renderAll();
            } catch (error) {
                console.error('加载数据失败:', error);
                document.getElementById('updateTime').textContent = '数据加载失败，请检查 data/dashboard_data.json';
            }
        }

        // 渲染所有内容
        function renderAll() {
            renderFunnel();
            renderTrend();
            renderDeepMetrics();
        }

        // 切换时间周期
        function setPeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });
            renderFunnel();
        }

        // 切换深度指标时间周期
        function setDeepMetricsPeriod(period) {
            deepMetricsPeriod = period;
            document.querySelectorAll('.deep-period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });
            renderDeepMetrics();
        }

        // 切换趋势图视图
        function setTrendView(view) {
            trendView = view;
            document.querySelectorAll('.view-toggle .toggle-btn[data-view]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            renderTrend();
        }

        // 渲染漏斗
        function renderFunnel() {
            const data = dashboardData.funnel[currentPeriod];
            const stepDetails = dashboardData.step_details[currentPeriod] || {};

            // 漏斗步骤定义
            const steps = [
                { step: 1, name: '曝光', key: 'page_voice_clone_exposure' },
                { step: 2, name: '克隆声音添加', key: 'voice_clone_add_voice_click' },
                { step: 3, name: '试听', key: 'voice_clone_preview_listen_play_click' },
                { step: 4, name: '保存成功', key: 'voice_clone_save_success' },
                { step: 5, name: '离开页面', key: 'exit_page', isComposite: true }
            ];

            const firstStepUsers = data['page_voice_clone_expourse']?.users || 0;

            // 漏斗图数据
            const funnelData = steps.map(step => ({
                name: step.name,
                value: data[step.key]?.users || 0
            }));

            // 详情列表
            const detailsHtml = [];
            let prevUsers = 0;

            steps.forEach((step, index) => {
                const stepData = data[step.key] || { count: 0, users: 0 };
                const users = stepData.users;
                const count = stepData.count;

                const stepRate = index === 0 ? '100%' : (prevUsers > 0 ? ((users / prevUsers) * 100).toFixed(1) + '%' : '0%');
                const overallRate = firstStepUsers > 0 ? ((users / firstStepUsers) * 100).toFixed(1) + '%' : '0%';

                let detailInfo = '';

                // 步骤2：克隆声音添加 - 按来源分布
                if (step.key === 'voice_clone_add_voice_click') {
                    const addFrom = stepDetails.add_voice_from || {};
                    const fromCreation = addFrom['/tts/creation'] || { users: 0 };
                    const fromLib = addFrom['/voice/lib'] || { users: 0 };
                    const totalFrom = fromCreation.users + fromLib.users;
                    detailInfo = `
                        <div class="step-detail-breakdown">
                            <div>从 Creation: ${fromCreation.users.toLocaleString()} 人 (${totalFrom ? ((fromCreation.users/totalFrom)*100).toFixed(1) : 0}%)</div>
                            <div>从 Library: ${fromLib.users.toLocaleString()} 人 (${totalFrom ? ((fromLib.users/totalFrom)*100).toFixed(1) : 0}%)</div>
                        </div>
                    `;
                }

                // 步骤3：试听 - 手动选择片段
                if (step.key === 'voice_clone_preview_listen_play_click') {
                    const manualSelect = stepDetails.manual_select || { users: 0 };
                    detailInfo = `
                        <div class="step-detail-breakdown">
                            <div>手动选择片段: ${manualSelect.users.toLocaleString()} 人 (${users ? ((manualSelect.users/users)*100).toFixed(1) : 0}%)</div>
                        </div>
                    `;
                }

                // 步骤5：离开页面分布
                if (step.key === 'exit_page') {
                    const exitDist = stepDetails.exit_distribution || {};
                    const useData = exitDist['voice_clone_save_voice_use'] || { users: 0 };
                    const backData = exitDist['voice_clone_complete_back'] || { users: 0 };
                    const totalExit = useData.users + backData.users;
                    detailInfo = `
                        <div class="step-detail-breakdown">
                            <div>Use (去TTS): ${useData.users.toLocaleString()} 人 (${totalExit ? ((useData.users/totalExit)*100).toFixed(1) : 0}%)</div>
                            <div>Back (回Library): ${backData.users.toLocaleString()} 人 (${totalExit ? ((backData.users/totalExit)*100).toFixed(1) : 0}%)</div>
                        </div>
                    `;
                }

                detailsHtml.push(`
                    <div class="funnel-step">
                        <div class="step-number">${step.step}</div>
                        <div class="step-info">
                            <div class="step-name">${step.name}</div>
                            <div class="step-event">${step.isComposite ? '复合指标' : step.key}</div>
                            ${detailInfo}
                        </div>
                        <div class="step-metrics">
                            <div class="step-metrics-row">
                                <div class="step-metric-col">
                                    <div class="step-metric-label">去重用户数</div>
                                    <div class="step-metric-value users">${users.toLocaleString()}</div>
                                </div>
                                <div class="step-metric-col">
                                    <div class="step-metric-label">事件触发次数</div>
                                    <div class="step-metric-value count">${count.toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="step-rate">上步转化 ${stepRate}</div>
                            <div class="step-rate-overall">整体转化(vs曝光) ${overallRate}</div>
                        </div>
                    </div>
                `);

                prevUsers = users;
            });

            document.getElementById('funnelDetails').innerHTML = detailsHtml.join('');

            // 绘制漏斗图
            const chart = echarts.init(document.getElementById('funnelChart'));
            chart.setOption({
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} 人'
                },
                series: [{
                    type: 'funnel',
                    left: '10%',
                    top: 20,
                    bottom: 20,
                    width: '80%',
                    min: 0,
                    max: funnelData[0]?.value || 100,
                    minSize: '20%',
                    maxSize: '100%',
                    sort: 'descending',
                    gap: 2,
                    label: {
                        show: true,
                        position: 'inside',
                        formatter: '{b}\n{c}',
                        color: '#fff',
                        fontSize: 12
                    },
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 1
                    },
                    emphasis: {
                        label: {
                            fontSize: 14
                        }
                    },
                    data: funnelData,
                    color: ['#f093fb', '#f5576c', '#fda085', '#f6d365', '#84fab0']
                }]
            });
        }

        // 渲染趋势图（固定14天）
        function renderTrend() {
            const trendData = dashboardData.trends || {};
            const dates = Object.keys(trendData).sort();

            const eventNames = {
                'page_voice_clone_exposure': '曝光',
                'voice_clone_add_voice_click': '克隆添加',
                'voice_clone_preview_listen_play_click': '试听',
                'voice_clone_save_success': '保存成功'
            };

            const series = Object.keys(eventNames).map(eventKey => {
                const eventLabel = eventNames[eventKey];
                let seriesData;

                if (trendView === 'percentage') {
                    seriesData = dates.map(date => {
                        const dayData = trendData[date] || {};
                        const exposure = dayData['page_voice_clone_exposure'] || 1;
                        const value = dayData[eventKey] || 0;
                        return ((value / exposure) * 100).toFixed(2);
                    });
                } else {
                    seriesData = dates.map(date => trendData[date]?.[eventKey] || 0);
                }

                return {
                    name: eventLabel,
                    type: 'line',
                    smooth: true,
                    data: seriesData
                };
            });

            const chart = echarts.init(document.getElementById('trendChart'));
            chart.setOption({
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                            const suffix = trendView === 'percentage' ? '%' : ' 人';
                            result += `${param.marker} ${param.seriesName}: ${param.value}${suffix}<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: Object.values(eventNames),
                    top: 0,
                    textStyle: { color: '#718096' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: { color: '#718096' },
                    axisLine: { lineStyle: { color: '#e2e8f0' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        color: '#718096',
                        formatter: trendView === 'percentage' ? '{value}%' : '{value}'
                    },
                    splitLine: { lineStyle: { color: '#e2e8f0' } }
                },
                series: series,
                color: ['#f093fb', '#f5576c', '#fda085', '#84fab0']
            });

            document.getElementById('trendFooter').textContent =
                trendView === 'percentage' ? '* 比例视图：各步骤相对于曝光的百分比' : '* 绝对数量视图：去重用户数';
        }

        // 渲染深度指标
        function renderDeepMetrics() {
            const metrics = dashboardData.deep_metrics[deepMetricsPeriod] || {};

            const completion = metrics.completion || {};
            const saveToUse = metrics.save_to_use || {};
            const upgrade = metrics.upgrade_conversion || {};

            document.getElementById('deepMetrics').innerHTML = `
                <div class="metric-group">
                    <div class="metric-group-title">完成率</div>
                    <div class="metric-item">
                        <div class="metric-name">保存音色用户 / 曝光用户</div>
                        <div class="metric-value-row">
                            <div class="metric-main-value">${completion.rate || 0}%</div>
                            <div class="metric-sub-value">${(completion.save_users || 0).toLocaleString()} / ${(completion.exposure_users || 0).toLocaleString()}</div>
                        </div>
                    </div>
                </div>

                <div class="metric-group">
                    <div class="metric-group-title">保存后使用</div>
                    <div class="metric-item">
                        <div class="metric-name">保存后去 TTS 使用的用户占比</div>
                        <div class="metric-value-row">
                            <div class="metric-main-value">${saveToUse.user_rate || 0}%</div>
                            <div class="metric-sub-value">${(saveToUse.use_tts_users || 0).toLocaleString()} / ${(saveToUse.save_users || 0).toLocaleString()} 用户</div>
                        </div>
                    </div>
                </div>

                <div class="metric-group">
                    <div class="metric-group-title">付费转化</div>
                    <div class="metric-item">
                        <div class="metric-name">点击升级弹窗的用户数</div>
                        <div class="metric-value-row">
                            <div class="metric-main-value">${(upgrade.upgrade_click_users || 0).toLocaleString()}</div>
                            <div class="metric-sub-value">voice_clone_upgrade_click</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 事件绑定
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', () => setPeriod(btn.dataset.period));
        });

        document.querySelectorAll('.deep-period-btn').forEach(btn => {
            btn.addEventListener('click', () => setDeepMetricsPeriod(btn.dataset.period));
        });

        // 初始化
        loadData();
    </script>
</body>
</html>
